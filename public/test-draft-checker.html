<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Draft Checker - Firebase Test</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      background: #f5f5f5; 
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      background: white; 
      padding: 20px; 
      border-radius: 8px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .button { 
      padding: 10px 20px; 
      margin: 5px; 
      background: #2196F3; 
      color: white; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
    }
    .button:hover { background: #1976D2; }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #FF9800; }
    .info { color: #2196F3; }
    #output { 
      background: #f8f9fa; 
      border: 1px solid #dee2e6; 
      padding: 15px; 
      margin: 10px 0; 
      border-radius: 4px; 
      white-space: pre-wrap; 
      font-family: 'Courier New', monospace;
      min-height: 100px;
      max-height: 500px;
      overflow-y: auto;
    }
    .loading { 
      opacity: 0.6; 
      pointer-events: none; 
    }
    .stats { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 15px; 
      margin: 15px 0; 
    }
    .stat-card { 
      padding: 15px; 
      background: #e3f2fd; 
      border-radius: 8px; 
      text-align: center; 
    }
    .stat-value { 
      font-size: 2em; 
      font-weight: bold; 
      color: #1976d2; 
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Draft Checker - Firebase Test</h1>
    <p>This tool checks if your draft "09.02" was successfully saved to Firebase and provides detailed information.</p>
    
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="draftCount">?</div>
        <div>Total Drafts</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="scheduleCount">?</div>
        <div>Total Schedules</div>
      </div>
    </div>
    
    <div>
      <button class="button" onclick="checkHealth()">üè• Quick Health Check</button>
      <button class="button" onclick="checkDraft()">üîç Check Draft "09.02"</button>
      <button class="button" onclick="listAllDrafts()">üìã List All Drafts</button>
      <button class="button" onclick="runFullTest()">üß™ Run Full Firebase Test</button>
      <button class="button" onclick="clearOutput()">üßπ Clear Output</button>
    </div>
    
    <div id="output">Waiting for Firebase to initialize...</div>
    
    <div style="margin-top: 20px; font-size: 12px; color: #666;">
      <strong>Instructions:</strong><br>
      1. Make sure you're signed into Firebase (if required)<br>
      2. Click "Check Draft '09.02'" to specifically look for your draft<br>
      3. Use "List All Drafts" to see all available drafts<br>
      4. "Run Full Firebase Test" performs comprehensive connectivity tests
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      getDocs, 
      orderBy 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { 
      getAuth, 
      signInAnonymously, 
      onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Firebase configuration (from your project)
    const firebaseConfig = {
      apiKey: "AIzaSyCvMBU3v9LT-7Tl0OEAJ0fNGgIRMp-sGUg",
      authDomain: "barrie-scheduler.firebaseapp.com",
      projectId: "barrie-scheduler",
      storageBucket: "barrie-scheduler.appspot.com",
      messagingSenderId: "1051088894456",
      appId: "1:1051088894456:web:c36b0e93d79a5b7f9a15b8",
      measurementId: "G-ZCTZ88GQ0F"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    let currentUser = null;
    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      output.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      output.scrollTop = output.scrollHeight;
    }

    function setLoading(loading) {
      document.body.classList.toggle('loading', loading);
    }

    // Authentication
    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user) {
        log(`Authenticated as: ${user.email || user.uid}`, 'success');
        updateStats();
      } else {
        log('Not authenticated - signing in anonymously...', 'warning');
        signInAnonymously(auth);
      }
    });

    async function updateStats() {
      if (!currentUser) return;
      
      try {
        // Count drafts
        const draftsQuery = query(
          collection(db, 'draft_schedules'),
          where('userId', '==', currentUser.uid)
        );
        const draftsSnapshot = await getDocs(draftsQuery);
        
        // Count schedules
        const schedulesQuery = query(
          collection(db, 'schedules'),
          where('userId', '==', currentUser.uid)
        );
        const schedulesSnapshot = await getDocs(schedulesQuery);
        
        document.getElementById('draftCount').textContent = draftsSnapshot.size;
        document.getElementById('scheduleCount').textContent = schedulesSnapshot.size;
        
      } catch (error) {
        log(`Error updating stats: ${error.message}`, 'error');
      }
    }

    window.checkHealth = async function() {
      setLoading(true);
      log('üè• Running health check...');
      
      try {
        if (!currentUser) {
          log('Not authenticated yet - please wait for authentication', 'warning');
          return;
        }
        
        // Try a simple read operation
        const testQuery = query(
          collection(db, 'draft_schedules'),
          where('userId', '==', currentUser.uid)
        );
        await getDocs(testQuery);
        
        await updateStats();
        log('Health check passed! Firebase is working correctly.', 'success');
        
      } catch (error) {
        log(`Health check failed: ${error.message}`, 'error');
      } finally {
        setLoading(false);
      }
    };

    window.checkDraft = async function() {
      setLoading(true);
      log('üîç Searching for draft "09.02"...');
      
      try {
        if (!currentUser) {
          log('Not authenticated yet - please wait for authentication', 'warning');
          return;
        }
        
        const draftsQuery = query(
          collection(db, 'draft_schedules'),
          where('userId', '==', currentUser.uid),
          orderBy('updatedAt', 'desc')
        );
        
        const snapshot = await getDocs(draftsQuery);
        const drafts = [];
        
        snapshot.forEach((doc) => {
          const data = doc.data();
          drafts.push({
            id: doc.id,
            fileName: data.fileName,
            fileType: data.fileType,
            processingStep: data.processingStep,
            createdAt: data.createdAt?.toDate?.()?.toISOString() || data.createdAt,
            updatedAt: data.updatedAt?.toDate?.()?.toISOString() || data.updatedAt,
            autoSaved: data.autoSaved
          });
        });
        
        log(`Found ${drafts.length} total drafts`);
        
        // Look for "09.02" draft
        const targetDraft = drafts.find(draft => {
          const fileName = draft.fileName.toLowerCase();
          return (
            fileName === '09.02' ||
            fileName.includes('09.02') ||
            fileName.endsWith('09.02') ||
            fileName.replace(/[^a-z0-9]/g, '').includes('0902')
          );
        });
        
        if (targetDraft) {
          log(`‚úÖ Found draft "09.02"!`, 'success');
          log(`   ID: ${targetDraft.id}`);
          log(`   Full name: "${targetDraft.fileName}"`);
          log(`   File type: ${targetDraft.fileType}`);
          log(`   Processing step: ${targetDraft.processingStep}`);
          log(`   Created: ${targetDraft.createdAt}`);
          log(`   Updated: ${targetDraft.updatedAt}`);
          log(`   Auto-saved: ${targetDraft.autoSaved}`);
        } else {
          log(`‚ùå Draft "09.02" not found`, 'error');
          log('Available drafts:');
          if (drafts.length === 0) {
            log('   (no drafts found)');
          } else {
            drafts.forEach((draft, index) => {
              log(`   ${index + 1}. "${draft.fileName}" (${draft.fileType}, ${draft.processingStep})`);
            });
          }
        }
        
      } catch (error) {
        log(`Error checking draft: ${error.message}`, 'error');
      } finally {
        setLoading(false);
      }
    };

    window.listAllDrafts = async function() {
      setLoading(true);
      log('üìã Fetching all drafts...');
      
      try {
        if (!currentUser) {
          log('Not authenticated yet - please wait for authentication', 'warning');
          return;
        }
        
        const draftsQuery = query(
          collection(db, 'draft_schedules'),
          where('userId', '==', currentUser.uid),
          orderBy('updatedAt', 'desc')
        );
        
        const snapshot = await getDocs(draftsQuery);
        
        if (snapshot.empty) {
          log('No drafts found in Firebase', 'warning');
          return;
        }
        
        log(`Found ${snapshot.size} drafts:`);
        
        snapshot.forEach((doc, index) => {
          const data = doc.data();
          log(`\n${index + 1}. "${data.fileName}"`);
          log(`   ID: ${doc.id}`);
          log(`   Type: ${data.fileType}`);
          log(`   Step: ${data.processingStep}`);
          log(`   Created: ${data.createdAt?.toDate?.()?.toLocaleString() || data.createdAt}`);
          log(`   Updated: ${data.updatedAt?.toDate?.()?.toLocaleString() || data.updatedAt}`);
          log(`   Auto-saved: ${data.autoSaved}`);
        });
        
      } catch (error) {
        log(`Error listing drafts: ${error.message}`, 'error');
      } finally {
        setLoading(false);
      }
    };

    window.runFullTest = async function() {
      setLoading(true);
      log('üß™ Running comprehensive Firebase tests...');
      
      try {
        // Test 1: Authentication
        log('1. Testing authentication...');
        if (currentUser) {
          log(`   ‚úÖ Authenticated as: ${currentUser.email || currentUser.uid}`, 'success');
        } else {
          log('   ‚ùå Not authenticated', 'error');
          return;
        }
        
        // Test 2: Database connection
        log('2. Testing database connection...');
        const testQuery = query(collection(db, 'draft_schedules'));
        await getDocs(testQuery);
        log('   ‚úÖ Database connection working', 'success');
        
        // Test 3: User-specific data
        log('3. Testing user-specific data access...');
        const userQuery = query(
          collection(db, 'draft_schedules'),
          where('userId', '==', currentUser.uid)
        );
        const userSnapshot = await getDocs(userQuery);
        log(`   ‚úÖ Can access user data (${userSnapshot.size} drafts)`, 'success');
        
        // Test 4: Data integrity
        log('4. Testing data integrity...');
        let validDrafts = 0;
        userSnapshot.forEach((doc) => {
          const data = doc.data();
          if (data.fileName && data.fileType && data.processingStep) {
            validDrafts++;
          }
        });
        log(`   ‚úÖ ${validDrafts}/${userSnapshot.size} drafts have valid structure`, 'success');
        
        log('üéâ All tests passed! Firebase is working correctly.', 'success');
        
      } catch (error) {
        log(`‚ùå Test failed: ${error.message}`, 'error');
      } finally {
        setLoading(false);
      }
    };

    window.clearOutput = function() {
      output.textContent = 'Output cleared.\n';
    };

    // Auto-run health check on load
    setTimeout(() => {
      if (currentUser) {
        log('üöÄ Page loaded - running initial health check...');
        checkHealth();
      }
    }, 2000);
  </script>
</body>
</html>