import React, { useState, useRef, useCallback, useMemo, memo, useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import {
  Container,
  Typography,
  Box,
  Button,
  Card,
  CardContent,
  Chip,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Paper,
  Breadcrumbs,
  Link,
  useTheme
} from '@mui/material';
import {
  ArrowBack as BackIcon,
  Fullscreen as FullscreenIcon,
  Home as HomeIcon,
  NavigateNext as NavigateNextIcon,
  Save as SaveIcon
} from '@mui/icons-material';
import { calculateTripTime } from '../utils/dateHelpers';
import { scheduleStorage } from '../services/scheduleStorage';
import { SummarySchedule } from '../types/schedule';

// Service Band Types based on travel time data from TimePoints analysis
export type ServiceBand = 'Fastest Service' | 'Fast Service' | 'Standard Service' | 'Slow Service' | 'Slowest Service';

interface TimePoint {
  id: string;
  name: string;
  sequence: number;
}

interface ServiceBandInfo {
  name: ServiceBand;
  totalMinutes: number;
  color: string;
}

interface Trip {
  tripNumber: number;
  blockNumber: number;
  departureTime: string;
  serviceBand: ServiceBand;
  arrivalTimes: { [timePointId: string]: string };
  departureTimes: { [timePointId: string]: string };
  recoveryTimes: { [timePointId: string]: number };
  serviceBandInfo?: ServiceBandInfo;
  recoveryMinutes: number;
}

interface Schedule {
  id: string;
  name: string;
  timePoints: TimePoint[];
  serviceBands: ServiceBandInfo[];
  trips: Trip[];
  updatedAt: string;
  blockConfigurations?: BlockConfiguration[];
  cycleTimeMinutes?: number;
  // TimePoints data for service band mapping
  timePointData?: TimePointData[];
  // Deleted time periods from TimePoints analysis
  deletedPeriods?: string[];
  // Service band assignments by time period (direct lookup)
  timePeriodServiceBands?: { [timePeriod: string]: ServiceBand };
}

// TimePoint data structure from TimePoints analysis
interface TimePointData {
  fromTimePoint: string;
  toTimePoint: string;
  timePeriod: string;
  percentile50: number;
  percentile80: number;
  isOutlier?: boolean;
  outlierType?: 'high' | 'low';
  outlierDeviation?: number;
}

interface BlockConfiguration {
  blockNumber: number;
  startTime: string;
  endTime: string;
}

/**
 * Determines service band based on trip departure time using direct lookup from TimePoints data
 * This uses the pre-calculated service band assignments from the TimePoints page
 */
const getServiceBand = (
  timeString: string, 
  timePeriodServiceBands: { [timePeriod: string]: ServiceBand } = {},
  timePointData: TimePointData[] = []
): ServiceBand => {
  // Parse the departure time to find matching time period
  const [tripHours, tripMinutes] = timeString.split(':').map(Number);
  const tripTotalMinutes = tripHours * 60 + tripMinutes;
  
  // Find matching time period 
  let matchingPeriod: string | null = null;
  
  // If we have the direct service band mapping, use it
  if (Object.keys(timePeriodServiceBands).length > 0) {
    for (const timePeriod of Object.keys(timePeriodServiceBands)) {
      const [startTime, endTime] = timePeriod.split(' - ');
      
      // Parse start time
      const [startHours, startMins] = startTime.split(':').map(Number);
      const startMinutes = startHours * 60 + startMins;
      
      // Parse end time 
      const [endHours, endMins] = endTime.split(':').map(Number);
      const endMinutes = endHours * 60 + endMins;
      
      // Check if trip time falls within this period
      if (tripTotalMinutes >= startMinutes && tripTotalMinutes < endMinutes) {
        matchingPeriod = timePeriod;
        break;
      }
    }
    
    if (matchingPeriod) {
      const serviceBand = timePeriodServiceBands[matchingPeriod];
      return serviceBand;
    }
  }
  
  // Fallback: try to find from timePointData if direct mapping not available
  if (timePointData.length > 0) {
    for (const data of timePointData) {
      const timePeriod = data.timePeriod;
      const [startTime, endTime] = timePeriod.split(' - ');
      
      const [startHours, startMins] = startTime.split(':').map(Number);
      const startMinutes = startHours * 60 + startMins;
      
      const [endHours, endMins] = endTime.split(':').map(Number);
      const endMinutes = endHours * 60 + endMins;
      
      if (tripTotalMinutes >= startMinutes && tripTotalMinutes < endMinutes) {
        matchingPeriod = timePeriod;
        break;
      }
    }
  }
  
  // Final fallback: time-based logic
  const [hours] = timeString.split(':').map(Number);
  if (hours >= 7 && hours < 9) return 'Fastest Service';    // Early morning - light traffic
  if (hours >= 9 && hours < 12) return 'Fast Service';     // Mid morning
  if (hours >= 12 && hours < 15) return 'Standard Service'; // Midday
  if (hours >= 15 && hours < 18) return 'Slow Service';     // Afternoon - heavy traffic  
  return 'Slowest Service';  // Peak hours and other times
};

/**
 * Gets color for service band (matching TimePoints page colors)
 */
const getServiceBandColor = (serviceBand: ServiceBand): string => {
  switch (serviceBand) {
    case 'Fastest Service': return '#2e7d32';  // Green
    case 'Fast Service': return '#388e3c';     // Light Green
    case 'Standard Service': return '#f9a825'; // Amber
    case 'Slow Service': return '#f57c00';     // Orange  
    case 'Slowest Service': return '#d32f2f';  // Red
    default: return '#9b9b9b';
  }
};

const BlockSummarySchedule: React.FC = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const theme = useTheme();
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [visibleRange, setVisibleRange] = useState({ start: 0, end: 50 });
  const [saving, setSaving] = useState(false);
  const [saveSuccess, setSaveSuccess] = useState(false);
  const tableContainerRef = useRef<HTMLDivElement>(null);

  // Load schedule from state or localStorage persistence
  const [schedule, setSchedule] = useState<Schedule>(() => {
    // Try location state first (from navigation)
    if (location.state?.schedule) {
      const scheduleData = location.state.schedule;
      // Save to localStorage for persistence
      localStorage.setItem('currentSummarySchedule', JSON.stringify(scheduleData));
      return scheduleData;
    }
    
    // Try localStorage (for persistence)
    const savedSchedule = localStorage.getItem('currentSummarySchedule');
    if (savedSchedule) {
      try {
        return JSON.parse(savedSchedule);
      } catch (error) {
        console.error('Failed to parse saved schedule:', error);
      }
    }
    
    // Fallback to empty schedule
    return {
      id: '',
      name: 'Generated Schedule',
      timePoints: [],
      serviceBands: [],
      trips: [],
      updatedAt: new Date().toISOString()
    };
  });

  // Process trips to add service bands based on TimePoints data
  useEffect(() => {
    if (schedule.trips.length > 0) {
      // Update trips with service bands if not already present
      const updatedTrips = schedule.trips.map(trip => ({
        ...trip,
        serviceBand: trip.serviceBand || getServiceBand(
          trip.departureTime, 
          schedule.timePeriodServiceBands || {}, 
          schedule.timePointData || []
        )
      }));
      
      // Only update if we actually added service bands
      if (updatedTrips.some(trip => !schedule.trips.find(t => t.tripNumber === trip.tripNumber)?.serviceBand)) {
        // In a real app, we'd update the state/context here
        // For now, we'll handle it in the processing logic below
      }
    }
  }, [schedule.trips, schedule.timePointData, schedule.timePeriodServiceBands]);

  // New simplified trip row component
  const TripRow = memo(({ trip, idx }: { trip: Trip; idx: number }) => {
    const serviceBandColor = getServiceBandColor(trip.serviceBand);
    
    // Calculate trip time from first to last timepoint departure
    const firstTimepointId = schedule.timePoints[0]?.id;
    const lastTimepointId = schedule.timePoints[schedule.timePoints.length - 1]?.id;
    const firstDepartureTime = firstTimepointId ? (trip.departureTimes[firstTimepointId] || trip.arrivalTimes[firstTimepointId]) : '';
    const lastDepartureTime = lastTimepointId ? (trip.departureTimes[lastTimepointId] || trip.arrivalTimes[lastTimepointId]) : '';
    const tripTime = calculateTripTime(firstDepartureTime || '', lastDepartureTime || '');
    
    return (
      <TableRow
        key={trip.tripNumber}
        sx={{
          height: '48px',
          backgroundColor: idx % 2 === 0 ? '#fafbfc' : '#ffffff',
          transition: 'all 0.2s ease-in-out',
          '&:hover': {
            backgroundColor: '#e3f2fd',
            transform: 'translateY(-1px)',
            boxShadow: '0 2px 8px rgba(0, 0, 0, 0.08)',
            '& .MuiTableCell-root': {
              fontWeight: '500'
            }
          }
        }}
      >
        {/* Block Number */}
        <TableCell sx={{ 
          p: '12px', 
          fontSize: '14px', 
          textAlign: 'center', 
          fontWeight: '600',
          color: '#475569',
          borderRight: '1px solid #e2e8f0',
          minWidth: '80px'
        }}>
          {trip.blockNumber}
        </TableCell>
        
        {/* Trip Number */}
        <TableCell sx={{ 
          p: '12px', 
          fontSize: '16px', 
          textAlign: 'center', 
          fontWeight: 'bold',
          color: theme.palette.primary.dark,
          borderRight: '1px solid #e2e8f0',
          minWidth: '80px'
        }}>
          {trip.tripNumber}
        </TableCell>
        
        {/* Service Band */}
        <TableCell sx={{ 
          p: '8px', 
          textAlign: 'center',
          borderRight: '1px solid #e2e8f0',
          minWidth: '140px'
        }}>
          <Chip 
            label={trip.serviceBand}
            size="small"
            sx={{
              backgroundColor: `${serviceBandColor}20`,
              color: serviceBandColor,
              border: `1px solid ${serviceBandColor}40`,
              fontWeight: '600',
              fontSize: '0.75rem'
            }}
          />
        </TableCell>
        
        {/* Time Points */}
        {schedule.timePoints.map((tp, tpIndex) => (
          <TableCell 
            key={tp.id}
            sx={{ 
              p: '8px 12px', 
              fontSize: '13px', 
              textAlign: 'center',
              fontFamily: 'monospace',
              fontWeight: '500',
              color: '#334155',
              borderRight: '1px solid #f1f5f9',
              minWidth: '80px'
            }}
          >
            <Box>
              {/* Departure Time */}
              <Typography variant="body2" sx={{ fontWeight: '600', fontSize: '0.85rem' }}>
                {trip.departureTimes[tp.id] || trip.arrivalTimes[tp.id] || '-'}
              </Typography>
              {/* Recovery Time */}
              {trip.recoveryTimes && trip.recoveryTimes[tp.id] > 0 && (
                <Typography variant="caption" sx={{ 
                  color: '#666', 
                  fontSize: '0.7rem',
                  display: 'block',
                  lineHeight: '1.2'
                }}>
                  +{trip.recoveryTimes[tp.id]}min
                </Typography>
              )}
            </Box>
          </TableCell>
        ))}
        
        {/* Trip Time */}
        <TableCell sx={{ 
          p: '12px', 
          fontSize: '13px', 
          textAlign: 'center',
          fontFamily: 'monospace',
          fontWeight: '600',
          color: '#1976d2',
          backgroundColor: '#f3f7ff',
          minWidth: '80px'
        }}>
          {tripTime}
        </TableCell>
      </TableRow>
    );
  });

  // Process trips to ensure they have service bands
  const processedTrips = useMemo(() => {
    return schedule.trips.map(trip => ({
      ...trip,
      serviceBand: trip.serviceBand || getServiceBand(
        trip.departureTime, 
        schedule.timePeriodServiceBands || {}, 
        schedule.timePointData || []
      )
    }));
  }, [schedule.trips, schedule.timePointData, schedule.timePeriodServiceBands]);

  const blockStats = useMemo(() => {
    const blocks = new Map<number, Trip[]>();
    processedTrips.forEach((trip: Trip) => {
      if (!blocks.has(trip.blockNumber)) {
        blocks.set(trip.blockNumber, []);
      }
      blocks.get(trip.blockNumber)!.push(trip);
    });
    
    return Array.from(blocks.entries()).map(([blockNum, trips]) => {
      const firstTrip = trips[0];
      const lastTrip = trips[trips.length - 1];
      
      return {
        blockNumber: blockNum,
        tripCount: trips.length,
        startTime: firstTrip.departureTime,
        endTime: lastTrip.departureTime
      };
    });
  }, [processedTrips]);


  // Sort trips by departure time
  const sortedTrips = useMemo(() => {
    return [...processedTrips].sort((a, b) => {
      return a.departureTime.localeCompare(b.departureTime);
    });
  }, [processedTrips]);

  // Get visible trips for virtualization
  const visibleTrips = useMemo(() => {
    if (sortedTrips.length <= 50) return sortedTrips;
    return sortedTrips.slice(visibleRange.start, visibleRange.end);
  }, [sortedTrips, visibleRange]);

  // Handle scroll for virtualization
  const handleScroll = useCallback((e: React.UIEvent<HTMLDivElement>) => {
    if (sortedTrips.length <= 50) return;
    
    const container = e.target as HTMLDivElement;
    const scrollTop = container.scrollTop;
    const rowHeight = 48; // Fixed row height - updated for larger design
    const containerHeight = container.clientHeight;
    
    const startIndex = Math.floor(scrollTop / rowHeight);
    const visibleCount = Math.ceil(containerHeight / rowHeight) + 10; // Buffer
    const endIndex = Math.min(startIndex + visibleCount, sortedTrips.length);
    
    setVisibleRange({ start: startIndex, end: endIndex });
  }, [sortedTrips.length]);


  const handleBack = () => {
    navigate(-1);
  };

  const handleSave = async () => {
    setSaving(true);
    setSaveSuccess(false);

    try {
      // Create a proper SummarySchedule object
      const summarySchedule: SummarySchedule = {
        routeId: `route_${Date.now()}`,
        routeName: schedule.name || 'Summary Schedule',
        direction: 'Outbound', // Could be made dynamic
        timePoints: schedule.timePoints || [],
        weekday: processedTrips.map(trip => 
          schedule.timePoints.map(tp => trip.departureTimes[tp.id] || trip.arrivalTimes[tp.id] || '')
        ),
        saturday: [], // Empty for now - could be populated if Saturday data available
        sunday: [],   // Empty for now - could be populated if Sunday data available
        effectiveDate: new Date(),
        expirationDate: undefined,
        metadata: {
          weekdayTrips: processedTrips.length,
          saturdayTrips: 0,
          sundayTrips: 0,
          frequency: schedule.cycleTimeMinutes ? Math.round(schedule.cycleTimeMinutes / (schedule.blockConfigurations?.length || 1)) : undefined,
          operatingHours: processedTrips.length > 0 ? {
            start: processedTrips[0].departureTime,
            end: processedTrips[processedTrips.length - 1].departureTime
          } : undefined
        }
      };

      // Save using the correct method
      const result = scheduleStorage.saveSchedule(
        summarySchedule,
        'csv', // File type
        schedule.name || 'Summary Schedule'
      );

      if (result.success) {
        setSaveSuccess(true);
        setTimeout(() => setSaveSuccess(false), 3000);
        console.log('Summary schedule saved successfully:', result.scheduleId);
      } else {
        console.error('Failed to save schedule:', result.error);
      }
    } catch (error) {
      console.error('Error saving schedule:', error);
    } finally {
      setSaving(false);
    }
  };

  if (schedule.trips.length === 0) {
    return (
      <Container maxWidth={false} sx={{ px: 3 }}>
          <Box sx={{ py: 4 }}>
            {/* Breadcrumbs now handled by WorkflowBreadcrumbs component */}

            <Card>
              <CardContent sx={{ textAlign: 'center', py: 8 }}>
                <Typography variant="h5" gutterBottom>
                  No Schedule Data
                </Typography>
                <Typography variant="body1" color="text.secondary" paragraph>
                  No schedule data was found. You can regenerate a schedule or go back to configure blocks.
                </Typography>
                <Box sx={{ display: 'flex', gap: 2, justifyContent: 'center', mt: 3 }}>
                  <Button 
                    variant="contained" 
                    onClick={() => navigate('/block-configuration')}
                    startIcon={<SaveIcon />}
                  >
                    Regenerate Schedule
                  </Button>
                  <Button 
                    variant="outlined" 
                    onClick={handleBack}
                    startIcon={<BackIcon />}
                  >
                    Go Back
                  </Button>
                </Box>
              </CardContent>
            </Card>
          </Box>
        </Container>
    );
  }

  return (
    <>
      <Container maxWidth={false} sx={{ px: 3 }}>
        <Box sx={{ py: 4 }}>
          {/* Breadcrumbs now handled by WorkflowBreadcrumbs component */}

          <Card elevation={2}>
            <CardContent sx={{ p: 4 }}>
              <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
                <Typography variant="h4" fontWeight="bold">
                  Summary Schedule
                </Typography>
                <Box display="flex" alignItems="center" gap={2}>
                  <Chip 
                    label={`${sortedTrips.length} trips • ${blockStats.length} bus blocks`}
                    color="primary"
                    size="medium"
                  />
                  {saveSuccess && (
                    <Chip 
                      label="✓ Saved"
                      color="success"
                      size="small"
                      sx={{ fontWeight: 'bold' }}
                    />
                  )}
                  <Button
                    variant="contained"
                    startIcon={<SaveIcon />}
                    onClick={handleSave}
                    disabled={saving}
                    size="small"
                    sx={{ 
                      backgroundColor: saving ? 'grey.400' : 'success.main',
                      '&:hover': { backgroundColor: 'success.dark' }
                    }}
                  >
                    {saving ? 'Saving...' : 'Save Schedule'}
                  </Button>
                  <Button
                    variant="outlined"
                    startIcon={<FullscreenIcon />}
                    onClick={() => setIsFullscreen(true)}
                    size="small"
                  >
                    Full Screen
                  </Button>
                  <Button
                    variant="outlined"
                    startIcon={<BackIcon />}
                    onClick={handleBack}
                    size="small"
                  >
                    Back
                  </Button>
                </Box>
              </Box>
              
              <TableContainer 
                component={Paper} 
                variant="outlined"
                ref={tableContainerRef}
                onScroll={handleScroll}
                sx={{ 
                  width: '100%', 
                  height: sortedTrips.length > 20 ? '650px' : '550px',
                  overflowX: 'auto',
                  overflowY: 'auto',
                  position: 'relative',
                  borderRadius: '8px',
                  border: '1px solid #e2e8f0',
                  boxShadow: '0 4px 12px rgba(0, 0, 0, 0.05)',
                  '&:hover': {
                    boxShadow: '0 6px 20px rgba(0, 0, 0, 0.08)'
                  }
                }}
              >
                <Table size="small" sx={{ 
                  width: '100%',
                  minWidth: '600px',
                  '& .MuiTableRow-root': {
                    borderBottom: '1px solid #f1f5f9'
                  }
                }}>
                  <TableHead sx={{ 
                    position: 'sticky',
                    top: 0,
                    zIndex: 10,
                    backgroundColor: 'white',
                    '&::after': {
                      content: '""',
                      position: 'absolute',
                      bottom: 0,
                      left: 0,
                      right: 0,
                      height: '2px',
                      background: 'linear-gradient(90deg, #1976d2 0%, #42a5f5 100%)'
                    }
                  }}>
                    <TableRow sx={{ 
                      background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                      '& .MuiTableCell-root': {
                        position: 'sticky',
                        top: 0,
                        background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                        zIndex: 10,
                        borderBottom: '2px solid #cbd5e1',
                        color: '#1e293b',
                        fontWeight: '700',
                        textTransform: 'uppercase',
                        letterSpacing: '0.5px',
                        padding: '16px 12px',
                        fontSize: '0.85rem'
                      }
                    }}>
                      {/* Block Number Column */}
                      <TableCell sx={{ 
                        textAlign: 'center',
                        minWidth: '80px',
                        borderRight: '1px solid #cbd5e1'
                      }}>
                        Block Number
                      </TableCell>
                      
                      {/* Trip Number Column */}
                      <TableCell sx={{ 
                        textAlign: 'center',
                        minWidth: '80px',
                        borderRight: '1px solid #cbd5e1'
                      }}>
                        Trip Number
                      </TableCell>
                      
                      {/* Service Band Column */}
                      <TableCell sx={{ 
                        textAlign: 'center',
                        minWidth: '140px',
                        borderRight: '1px solid #cbd5e1'
                      }}>
                        Service Band
                      </TableCell>
                      
                      {/* Time Points */}
                      {schedule.timePoints.map((tp, index) => (
                        <TableCell 
                          key={tp.id}
                          sx={{ 
                            textAlign: 'center',
                            borderRight: '1px solid #cbd5e1',
                            minWidth: '100px',
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap'
                          }}
                          title={`${tp.name} - Departure time & recovery time`}
                        >
                          <Box>
                            <Typography variant="body2" sx={{ fontWeight: '700', fontSize: '0.85rem' }}>
                              {tp.name}
                            </Typography>
                            <Typography variant="caption" sx={{ 
                              color: '#666', 
                              fontSize: '0.7rem',
                              display: 'block',
                              lineHeight: '1.2'
                            }}>
                              (Time + Recovery)
                            </Typography>
                          </Box>
                        </TableCell>
                      ))}
                      
                      {/* Trip Time Column */}
                      <TableCell sx={{ 
                        textAlign: 'center',
                        minWidth: '100px',
                        backgroundColor: '#f3f7ff',
                        fontWeight: '800'
                      }}>
                        Trip Time
                      </TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {/* Add spacer for virtualization offset */}
                    {sortedTrips.length > 50 && visibleRange.start > 0 && (
                      <TableRow sx={{ height: `${visibleRange.start * 48}px` }}>
                            <TableCell colSpan={4 + schedule.timePoints.length} sx={{ p: 0, border: 'none' }} />
                      </TableRow>
                    )}
                    
                    {visibleTrips.map((trip, idx) => {
                      const originalIdx = sortedTrips.length > 50 ? visibleRange.start + idx : idx;
                      return (
                        <TripRow
                          key={trip.tripNumber}
                          trip={trip}
                          idx={originalIdx}
                        />
                      );
                    })}
                    
                    {/* Add spacer for remaining items */}
                    {sortedTrips.length > 50 && visibleRange.end < sortedTrips.length && (
                      <TableRow sx={{ height: `${(sortedTrips.length - visibleRange.end) * 48}px` }}>
                            <TableCell colSpan={4 + schedule.timePoints.length} sx={{ p: 0, border: 'none' }} />
                      </TableRow>
                    )}
                  </TableBody>
                </Table>
              </TableContainer>
            </CardContent>
          </Card>
        </Box>
      </Container>

      {/* Simplified full screen overlay instead of Material-UI Dialog */}
      {isFullscreen && (
        <Box
          sx={{
            position: 'fixed',
            top: 0,
            left: 0,
            width: '100vw',
            height: '100vh',
            backgroundColor: 'white',
            zIndex: 9999,
            display: 'flex',
            flexDirection: 'column'
          }}
        >
          {/* Simple header */}
          <Box sx={{ 
            p: 2, 
            borderBottom: 1, 
            borderColor: 'divider',
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center'
          }}>
            <Typography variant="h5">
              Summary Schedule - Full Screen ({sortedTrips.length} trips)
            </Typography>
            <Button onClick={() => setIsFullscreen(false)} variant="outlined">
              Close
            </Button>
          </Box>
          
          {/* Reuse the same optimized table container */}
          <Box sx={{ flex: 1, p: 2, overflow: 'hidden' }}>
            <TableContainer 
              component={Paper} 
              variant="outlined"
              onScroll={handleScroll}
              sx={{ 
                width: '100%', 
                height: '100%',
                overflowX: 'auto',
                overflowY: 'auto'
              }}
            >
              <Table size="small" sx={{ 
                width: '100%',
                minWidth: '600px',
                '& .MuiTableRow-root': {
                  borderBottom: '1px solid #f1f5f9'
                }
              }}>
                <TableHead sx={{ 
                  position: 'sticky',
                  top: 0,
                  zIndex: 10,
                  backgroundColor: 'white',
                  '&::after': {
                    content: '""',
                    position: 'absolute',
                    bottom: 0,
                    left: 0,
                    right: 0,
                    height: '2px',
                    background: 'linear-gradient(90deg, #1976d2 0%, #42a5f5 100%)'
                  }
                }}>
                  <TableRow sx={{ 
                    background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                    '& .MuiTableCell-root': {
                      position: 'sticky',
                      top: 0,
                      background: 'linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%)',
                      zIndex: 10,
                      borderBottom: '2px solid #cbd5e1',
                      color: '#1e293b',
                      fontWeight: '700',
                      textTransform: 'uppercase',
                      letterSpacing: '0.5px',
                      padding: '16px 12px',
                      fontSize: '0.85rem'
                    }
                  }}>
                    {/* Block Number Column */}
                    <TableCell sx={{ 
                      textAlign: 'center',
                      minWidth: '80px',
                      borderRight: '1px solid #cbd5e1'
                    }}>
                      Block Number
                    </TableCell>
                    
                    {/* Trip Number Column */}
                    <TableCell sx={{ 
                      textAlign: 'center',
                      minWidth: '80px',
                      borderRight: '1px solid #cbd5e1'
                    }}>
                      Trip Number
                    </TableCell>
                    
                    {/* Service Band Column */}
                    <TableCell sx={{ 
                      textAlign: 'center',
                      minWidth: '140px',
                      borderRight: '1px solid #cbd5e1'
                    }}>
                      Service Band
                    </TableCell>
                    
                    {/* Time Points */}
                    {schedule.timePoints.map((tp, index) => (
                      <TableCell 
                        key={tp.id}
                        sx={{ 
                          textAlign: 'center',
                          borderRight: '1px solid #cbd5e1',
                          minWidth: '100px',
                          overflow: 'hidden',
                          textOverflow: 'ellipsis',
                          whiteSpace: 'nowrap'
                        }}
                        title={`${tp.name} - Departure time & recovery time`}
                      >
                        <Box>
                          <Typography variant="body2" sx={{ fontWeight: '700', fontSize: '0.85rem' }}>
                            {tp.name}
                          </Typography>
                          <Typography variant="caption" sx={{ 
                            color: '#666', 
                            fontSize: '0.7rem',
                            display: 'block',
                            lineHeight: '1.2'
                          }}>
                            (Time + Recovery)
                          </Typography>
                        </Box>
                      </TableCell>
                    ))}
                    
                    {/* Trip Time Column */}
                    <TableCell sx={{ 
                      textAlign: 'center',
                      minWidth: '100px',
                      backgroundColor: '#f3f7ff',
                      fontWeight: '800'
                    }}>
                      Trip Time
                    </TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {/* Reuse same virtualization logic */}
                  {sortedTrips.length > 50 && visibleRange.start > 0 && (
                    <TableRow sx={{ height: `${visibleRange.start * 48}px` }}>
                      <TableCell colSpan={4 + schedule.timePoints.length} sx={{ p: 0, border: 'none' }} />
                    </TableRow>
                  )}
                  
                  {visibleTrips.map((trip, idx) => {
                    const originalIdx = sortedTrips.length > 50 ? visibleRange.start + idx : idx;
                    return (
                      <TripRow
                        key={trip.tripNumber}
                        trip={trip}
                        idx={originalIdx}
                      />
                    );
                  })}
                  
                  {sortedTrips.length > 50 && visibleRange.end < sortedTrips.length && (
                    <TableRow sx={{ height: `${(sortedTrips.length - visibleRange.end) * 48}px` }}>
                      <TableCell colSpan={4 + schedule.timePoints.length} sx={{ p: 0, border: 'none' }} />
                    </TableRow>
                  )}
                </TableBody>
              </Table>
            </TableContainer>
          </Box>
        </Box>
      )}
    </>
  );
};

export default BlockSummarySchedule;